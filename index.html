<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buku Tamu KUA Rantepao</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f1f1f1; margin:0; padding:0; }
    .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 10px; margin-top: 30px; }
    h2 { text-align: center; color: #0b6623; }
    .input-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
    button { width: 100%; padding: 12px; background: #28a745; border: none; color: white; font-size: 16px; border-radius: 8px; cursor: pointer; }
    button:hover { background: #218838; }
    .toast { display: none; background: #28a745; color: white; padding: 15px; border-radius: 8px; text-align: center; margin-top: 10px; }
    .error { background: #dc3545 !important; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Buku Tamu KUA Rantepao</h2>
    <form id="guestForm">
      <div class="input-group">
        <label>Nama Lengkap</label>
        <input type="text" id="nama" required>
      </div>
      <div class="input-group">
        <label>Alamat</label>
        <input type="text" id="alamat" required>
      </div>
      <div class="input-group">
        <label>Nomor HP</label>
        <input type="tel" id="nohp" required>
      </div>
      <div class="input-group">
        <label>Tanggal</label>
        <input type="date" id="tgl" required>
      </div>
      <div class="input-group">
        <label>Maksud/Tujuan</label>
        <select id="keperluan" required>
          <option value="">-- Pilih Maksud/Tujuan --</option>
          <option>Pendaftaran Nikah</option>
          <option>Rekomendasi Nikah</option>
          <option>Konsultasi Agama</option>
          <option value="lainnya">Lainnya</option>
        </select>
        <input type="text" id="lainnyaInput" placeholder="Isi tujuan lainnya..." style="display:none; margin-top:10px;">
      </div>
      <button type="submit">Kirim</button>
    </form>
    <div id="toast" class="toast"></div>
  </div>

  <script>
    const SHEETDB_API = "https://sheetdb.io/api/v1/dnj3qebts72on";
    const OFFICE_LAT = -2.967013;
    const OFFICE_LNG = 119.905454;
    const RADIUS_M = 100;

    const form = document.getElementById("guestForm");
    const keperluan = document.getElementById("keperluan");
    const lainnyaInput = document.getElementById("lainnyaInput");
    const toast = document.getElementById("toast");

    keperluan.addEventListener("change", () => {
      if (keperluan.value === "lainnya") {
        lainnyaInput.style.display = "block";
        lainnyaInput.required = true;
      } else {
        lainnyaInput.style.display = "none";
        lainnyaInput.required = false;
      }
    });

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000; // meter
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    form.addEventListener("submit", e => {
      e.preventDefault();

      if (!navigator.geolocation) {
        showToast("Geolocation tidak didukung di browser Anda", true);
        return;
      }

      navigator.geolocation.getCurrentPosition(async pos => {
        const userLat = pos.coords.latitude;
        const userLng = pos.coords.longitude;

        const distance = haversine(userLat, userLng, OFFICE_LAT, OFFICE_LNG);

        if (distance > RADIUS_M) {
          showToast("Anda di luar radius 100m dari kantor. Data tidak bisa dikirim.", true);
          return;
        }

        const payload = {
          data: [{
            nama: document.getElementById("nama").value,
            alamat: document.getElementById("alamat").value,
            nohp: document.getElementById("nohp").value,
            tgl: document.getElementById("tgl").value,
            keperluan: keperluan.value === "lainnya" ? lainnyaInput.value : keperluan.value,
            latitude: userLat,
            longitude: userLng,
            timestamp: new Date().toLocaleString("id-ID", { timeZone: "Asia/Makassar" })
          }]
        };

        try {
          const res = await fetch(SHEETDB_API, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          if (res.ok) {
            showToast("âœ… Data berhasil disimpan");
            form.reset();
            lainnyaInput.style.display = "none";
          } else {
            showToast("Gagal menyimpan data", true);
          }
        } catch (err) {
          showToast("Error: " + err.message, true);
        }
      }, () => {
        showToast("Tidak bisa mendapatkan lokasi Anda", true);
      });
    });

    function showToast(msg, isError = false) {
      toast.innerText = msg;
      toast.classList.toggle("error", isError);
      toast.style.display = "block";
      setTimeout(() => toast.style.display = "none", 4000);
    }
  </script>
</body>
</html>
